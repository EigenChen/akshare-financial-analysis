# 财务分析脚本开发提示词

本文档记录了开发 `07_财务分析.py` 脚本过程中使用的提示词和需求说明。

## 1. 文件重命名和输出文件名格式调整

### 需求
- 将 `07_营收基本数据分析.py` 改名为 `07_财务分析.py`
- 生成的Excel文件名格式改为：`symbol_YYYY-YYYY_财务分析_时间戳.xlsx`
- 时间戳格式：`YYYYMMDDHHmmss`

### 示例
- 原格式：`科沃斯_2013_2024_财务分析.xlsx`
- 新格式：`科沃斯_2013-2024_财务分析_20241224143025.xlsx`

---

## 2. 添加"增长"Sheet

### 需求
新增一个Excel sheet，命名为"增长"，包含以下科目：

- 收入增长率（%）
- 归母净利润增长率（%）
- 最近5年复合增长率（%）
- 最近3年复合增长率（%）

### 计算规则
- 第一年的增长率显示为 "-"
- 最近m年的收入复合增长率计算公式：`(第N年收入/第N-m年收入)开m次方 - 1`
- 最终呈现格式：
  ```
  科目 | 2013年 | 2014年 | ... | 2024年 | 最近5年 | 最近3年
  收入增长率（%） | - | xx | ... | xxx | xxx | xxx
  归母净利润增长率（%） | - | xx | ... | xxx | xxx | xxx
  ```

---

## 3. 添加"资产负债"Sheet

### 需求
新增一个Excel sheet，命名为"资产负债"，包含以下科目：

- 流动资产（亿元）
- 现金（亿元）
- 存货（亿元）
- 非流动资产（亿元）
- 总资产（亿元）
- 归母净资产（亿元）
- 狭义无息债务（亿元）
- 广义无息债务（亿元）
- 有息债务（亿元）
- 狭义无息债务/收入（%）
- 狭义无息债务/总资产（%）
- 广义无息债务/收入（%）
- 广义无息债务/总资产（%）
- 有息债务/总资产（%）
- 资产负债率（%）

### 计算公式
- **狭义无息债务（亿元）** = 应付账款 + 预收账款 + 合同负债
- **广义无息债务（亿元）** = 应付账款 + 应付票据 + 预收账款 + 合同负债
- **有息债务（亿元）** = 短期借款 + 长期借款 + 应付债券

---

## 4. 添加"WC分析"Sheet

### 需求
新增一个Excel sheet，命名为"WC分析"，包含以下科目：

- 1元收入需要的WC（元）
- WC（亿元）
- 应收（亿元）
- 预付（亿元）
- 存货（亿元）
- 合同资产（亿元）
- 应付（亿元）
- 预收（亿元）
- 合同负债（亿元）
- 应收占收入比重（%）
- 预付占收入比重（%）
- 存货占收入比重（%）
- 应付占收入比重（%）
- 预收占收入比重（%）
- 合同负债占收入比重（%）
- 新增WC（亿元）

### WC定义和计算公式
根据《简明财务分析：数据背后的商业模式与投资价值》中的定义：

**WC（Working Capital，营运资金）** 是指企业在经营活动中真实垫付的自有流动资金。

**WC计算公式：**
```
WC = (应收账款 + 预付账款 + 存货 + 合同资产) - (应付账款 + 预收账款 + 合同负债)
```

**其他计算规则：**
- 1元收入需要的WC（元）= WC / 收入（精确到小数点后两位）
- 新增WC（亿元）= 当年WC - 上年WC（第一年显示"-"）
- 各项占收入比重（%）= 对应科目 / 收入 × 100

---

## 5. 添加"固定资产投入分析"Sheet

### 需求
新增一个Excel sheet，命名为"固定资产投入分析"，包含以下科目：

- 1元收入需要的固定资产（元）
- 1元收入需要的长期资产（元）
- 固定资产（亿元）
- 长期资产（亿元）
- 折旧（亿元）
- 折旧/收入（%）

### 计算公式
- **固定资产（亿元）** = 资产负债表上的固定资产 + 在建工程 + 工程物资 - 固定资产清理
- **长期资产（亿元）** = 固定资产 + 资产负债表其他长期经营资产（无形资产 + 开发支出 + 使用权资产 + 商誉 + 长期待摊费用）
- 1元收入需要的固定资产（元）= 固定资产 / 收入（精确到小数点后两位）
- 1元收入需要的长期资产（元）= 长期资产 / 收入（精确到小数点后两位）
- 折旧/收入（%）= 折旧 / 收入 × 100

### 公式说明
在生成的表格下方给出固定资产和长期资产的公式说明。

---

## 6. 添加"人均数据"Sheet

### 需求
新增一个Excel sheet，命名为"人均数据"，包含以下科目：

- 人数
- 人均收入（万元）
- 人均归母净利润（万元）
- 人均扣非净利润（万元）
- 人均薪酬（万元）

### 计算公式
- **人均收入（万元）** = 收入（亿元）/ 人数 × 10000
- **人均归母净利润（万元）** = 归母净利润（亿元）/ 人数 × 10000
- **人均扣非净利润（万元）** = 扣非净利润（亿元）/ 人数 × 10000

### 人均薪酬计算方式
假设：
- 应付职工薪酬期末余额为 A
- 年初余额为 B（上一年的期末余额）
- 现金流量表支付给职工以及为职工支付的现金为 C

**员工本年度薪酬总额** = A - B + C

**人均薪酬（万元）** = 总薪酬（亿元）/ 人数 × 10000

**注意：** 人数使用期末的，暂时不用（期初+期末）/ 2

### 员工数量数据来源
- **方式1：从CSV文件读取（推荐）**：支持从CSV文件按年份读取员工数量，CSV文件格式为 `xxxx_员工数量.csv`，包含"年份"和"员工数量"两列。如果提供CSV文件路径，则按年份读取对应的员工数量。
- **方式2：使用接口获取**：使用 `stock_individual_basic_info_xq` 接口获取员工人数，但该接口返回的是当前时点的员工人数，所有年份使用相同值。

**推荐使用方式1**，因为可以从年报PDF中提取各年份的实际员工数量，数据更准确。

---

## 7. 技术实现要求

### Excel文件处理
- 所有sheet保存到同一个Excel文件
- 使用时间戳确保文件名唯一性
- 处理文件句柄释放问题，避免"Permission denied"错误
- 如果文件已存在，追加sheet；否则创建新文件

### 数据获取
- 使用akshare库获取财务数据
- 从三大报表（利润表、资产负债表、现金流量表）中提取数据
- 处理数据缺失情况，缺失数据显示为 "-"

### 精度要求
- 金额单位：亿元（保留2位小数）
- 百分比：保留2位小数
- 1元收入需要的WC/固定资产/长期资产：保留2位小数

---

## 8. 字段映射说明

### 资产负债表字段
- `FIXED_ASSET` - 固定资产
- `CIP` - 在建工程
- `PROJECT_MATERIAL` - 工程物资
- `FIXED_ASSET_DISPOSAL` - 固定资产清理
- `INTANGIBLE_ASSET` - 无形资产
- `DEVELOP_EXPENSE` - 开发支出
- `USERIGHT_ASSET` - 使用权资产
- `GOODWILL` - 商誉
- `LONG_PREPAID_EXPENSE` - 长期待摊费用
- `ACCOUNTS_PAYABLE` - 应付账款
- `ADVANCE_RECEIVABLES` - 预收账款
- `CONTRACT_LIAB` - 合同负债
- `NOTE_PAYABLE` - 应付票据
- `STAFF_SALARY_PAYABLE` - 应付职工薪酬
- `TOTAL_CURRENT_ASSETS` - 流动资产合计
- `TOTAL_NONCURRENT_ASSETS` - 非流动资产合计
- `TOTAL_ASSETS` - 总资产
- `TOTAL_PARENT_EQUITY` - 归母净资产
- `TOTAL_LIABILITIES` - 总负债
- `MONETARYFUNDS` - 货币资金（现金）
- `SHORT_LOAN` - 短期借款
- `LONG_LOAN` - 长期借款
- `BONDS_PAYABLE` - 应付债券

### 利润表字段
- `OPERATE_INCOME` - 营业收入
- `PARENT_NETPROFIT` - 归母净利润
- `DEDUCT_PARENT_NETPROFIT` - 扣非净利润
- `OPERATE_COST` - 营业成本
- `OPERATE_PROFIT` - 营业利润
- `SALE_EXPENSE` - 销售费用
- `MANAGE_EXPENSE` - 管理费用
- `RESEARCH_EXPENSE` - 研发费用
- `FINANCE_EXPENSE` - 财务费用
- `FE_INTEREST_EXPENSE` - 财务费用中的利息支出
- `FAIRVALUE_CHANGE_INCOME` - 公允价值变动收益
- `INVEST_INCOME` - 投资收益

### 现金流量表字段
- `FIXED_ASSET_DEPR` / `FA_IR_DEPR` / `FA_DEPR` - 固定资产折旧
- `PAY_STAFF_CASH` - 支付给职工以及为职工支付的现金
- `NETCASH_OPERATE` - 经营净现金流
- `CONSTRUCT_LONG_ASSET` - 购建固定资产、无形资产和其他长期资产支付的现金（CAPEX）

### WC相关字段
- `ACCOUNTS_RECE` - 应收账款
- `PREPAYMENT` - 预付账款
- `INVENTORY` - 存货
- `CONTRACT_ASSET` - 合同资产

---

## 9. 注意事项

1. **员工人数获取**：
   - 推荐方式：从CSV文件读取员工数量（格式：`xxxx_员工数量.csv`），支持按年份读取，数据更准确。
   - 备用方式：使用 `stock_individual_basic_info_xq` 接口，但该接口返回的员工人数可能为 `None`，且所有年份使用相同值。如果无法获取，所有人均指标显示为 "-"。
   - 可以使用 `测试_从年报提取员工数量.py` 脚本从年报PDF中提取员工数量并生成CSV文件。

2. **数据缺失处理**：所有计算都应考虑数据缺失的情况，缺失时显示 "-"。

3. **年份范围**：确保所有sheet使用相同的年份范围，保持数据一致性。

4. **文件命名**：使用时间戳确保每次运行生成的文件名唯一，避免覆盖。

5. **平均值计算**：资产周转相关指标需要计算平均值（如平均总资产、平均流动资产等），第一年或上一年数据缺失时无法计算，显示为 "-"。

---

## 10. 添加"收益率和杜邦分析"Sheet

### 需求
新增一个Excel sheet，命名为"收益率和杜邦分析"，包含以下科目：

- ROE(%)
- ROA(%)
- ROIC(%)
- 销售净利率(%)
- 资产周转率（次）
- 权益乘数

### 计算公式
- **ROE(%)** = 归母净利润 / 归母净资产 × 100
- **ROA(%)** = 归母净利润 / 总资产 × 100
- **ROIC(%)** = EBIT / 投入资本 × 100
  - EBIT = 营业利润 + 利息支出
  - 投入资本 = 总资产 - 狭义无息债务（应付账款 + 预收账款 + 合同负债）
- **销售净利率(%)** = 归母净利润 / 营业收入 × 100
- **资产周转率（次）** = 营业收入 / 总资产
- **权益乘数** = 总资产 / 归母净资产

### 杜邦分析
杜邦分析公式：ROE = 销售净利率 × 资产周转率 × 权益乘数

---

## 11. 添加"资产周转"Sheet

### 需求
新增一个Excel sheet，命名为"资产周转"，包含以下科目：

- 总资产（亿元）
- 平均总资产（亿元）
- 平均流动资产（亿元）
- 平均存货（亿元）
- 归母净资产（亿元）
- 平均归母净资产（亿元）
- 总资产周转天数
- 流动资产周转天数
- WC周转天数
- 应收周转天数
- 存货周转天数
- 固定资产周转天数

### 计算公式
- **平均总资产（亿元）** = (上年总资产 + 当年总资产) / 2
- **平均流动资产（亿元）** = (上年流动资产 + 当年流动资产) / 2
- **平均存货（亿元）** = (上年存货 + 当年存货) / 2
- **平均归母净资产（亿元）** = (上年归母净资产 + 当年归母净资产) / 2
- **总资产周转天数** = (平均总资产 / 营业收入) × 365
- **流动资产周转天数** = (平均流动资产 / 营业收入) × 365
- **WC周转天数** = (平均WC / 营业收入) × 365
- **应收周转天数** = (平均应收账款 / 营业收入) × 365
- **存货周转天数** = (平均存货 / 营业收入) × 365
- **固定资产周转天数** = (平均固定资产 / 营业收入) × 365

### 注意事项
- 第一年无法计算平均值，显示为 "-"
- 平均值的计算需要上一年和当年的数据
- 固定资产 = 固定资产 + 在建工程 + 工程物资 - 固定资产清理

---

## 12. 最终输出

脚本应生成包含以下9个sheet的Excel文件：

1. **营收基本数据** - 收入、净利润、现金流等基本指标
2. **费用构成** - 毛利率、费用率等费用相关指标
3. **增长** - 增长率和复合增长率
4. **资产负债** - 资产、负债相关指标
5. **WC分析** - 营运资金分析
6. **固定资产投入分析** - 固定资产和长期资产分析
7. **收益率和杜邦分析** - ROE、ROA、ROIC等收益率指标和杜邦分析
8. **资产周转** - 各类资产周转天数分析
9. **人均数据** - 人均收入、人均利润、人均薪酬等

---

## 13. 港股支持说明

### 当前状态

当前代码主要针对**A股**设计，使用以下接口：
- `stock_balance_sheet_by_report_em` - A股资产负债表
- `stock_profit_sheet_by_report_em` - A股利润表
- `stock_cash_flow_sheet_by_report_em` - A股现金流量表

### 港股支持

AKShare支持港股财务报表数据，但接口和数据结构可能不同：

**港股接口（需要验证）：**
- `stock_financial_hk_report_em` - 港股财务报表
- `stock_financial_hk_profit_em` - 港股利润表（需验证）
- `stock_financial_hk_cashflow_em` - 港股现金流量表（需验证）

**港股代码格式：**
- 港股代码为5位数字，如 `00700`（腾讯控股）
- 不需要添加交易所后缀

### 实现港股支持的步骤

1. **测试接口可用性**
   - 运行 `测试_港股财务报表接口.py` 验证接口
   - 查看返回数据的字段名和结构

2. **创建字段映射**
   - 港股字段名可能与A股不同
   - 需要创建字段映射表

3. **统一数据格式**
   - 处理数据单位差异（港币 vs 人民币）
   - 统一报告期格式

4. **复用计算逻辑**
   - 大部分计算逻辑可以直接复用
   - 只需要调整数据获取部分

**详细说明请参考：`港股财务分析说明.md`**

